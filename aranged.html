<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI vs Real Image Detector</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
    /* --- DESIGN VARIABLES --- */
    :root{
        --bg-1:#070617; --bg-2:#06102a; --card:#07162a; --muted:#99b7d9;
        --accent1:#ff1e21; --accent2:#3248f2; --glass: rgba(255,255,255,0.04);
        --success: #2ec27e; --danger: #ff6b6b; --soft-border: rgba(255,255,255,0.06);
        --warning: #ffb74d;
    }
    *{box-sizing:border-box}
    body{
        margin:0; min-height:100vh; font-family:Inter,system-ui;
        background: radial-gradient(1200px 600px at 10% 10%, rgba(61,183,255,0.06), transparent),
                      linear-gradient(180deg,var(--bg-1), var(--bg-2));
        color:#e6eefb; padding:32px;
    }
    .wrap{ max-width:1300px; margin:0 auto; }
    .header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:26px; }
    .grid { display:grid; grid-template-columns: 1.4fr 0.8fr; gap:24px; }
    .card, .score-card {
        background: rgba(255,255,255,0.02); border-radius:14px; padding:20px;
        border:1px solid var(--soft-border); box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    }
    .drop-area{
        border-radius:12px; padding:20px; border:1px dashed rgba(255,255,255,0.1);
        text-align:center; min-height:150px; display:flex; flex-direction:column; justify-content:center;
    }
    .select-link {
        display:inline-block; padding:8px 16px; border-radius:999px;
        background: linear-gradient(90deg,var(--accent1),var(--accent2));
        color:#fff; cursor:pointer; font-size:13px; font-weight:700; text-decoration:none;
    }
    .preview {
        margin-top:20px; border-radius:10px; overflow:hidden; background:#050814;
        position: relative; min-height:300px; display:flex; justify-content:center;
    }
    .preview img{ max-width:100%; max-height:500px; object-fit:contain; }
    .analyze-bar{ height:6px; border-radius:999px; overflow:hidden; margin-top:15px; background:rgba(255,255,255,0.05); }
    .analyze-bar .fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); transition:width .3s; }
    .tag { display:inline-block; padding:6px 12px; border-radius:50px; font-weight:700; font-size:12px; }
    .tag.ai { background: rgba(255,107,107,0.15); color:var(--danger); }
    .tag.real { background: rgba(46,194,126,0.15); color:var(--success); }
    .tag.warn { background: rgba(255,183,77,0.15); color:var(--warning); }
    .meter { width:100px; height:100px; margin:20px auto; position:relative; display:flex; align-items:center; justify-content:center; }
    .meter svg { transform: rotate(-90deg); width:100%; height:100%; }
    .meter .num { position:absolute; font-weight:800; font-size:20px; color:#fff; }
    .breakdown-table { width: 100%; border-collapse: collapse; font-size:13px; }
    .breakdown-table td { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .btn { padding:10px 20px; border-radius:999px; border:none; cursor:pointer; font-weight:700; background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#fff; }
    .scan-line { position: absolute; top: 0; width: 100%; height: 2px; background: var(--accent2); display: none; animation: scan 2s infinite linear; }
    @keyframes scan { 0%{top:0%} 100%{top:100%} }
    .proof-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:15px; }
    .proof-slot { background:rgba(255,255,255,0.03); border-radius:8px; padding:8px; text-align:center; }
    .proof-thumb { width:100%; aspect-ratio:1; border-radius:6px; overflow:hidden; background:#000; margin-bottom:5px; }
    .proof-thumb img { width:100%; height:100%; object-fit:cover; }
    @media (max-width:980px){ .grid{ grid-template-columns: 1fr; } }
</style>
</head>
<body>
    <div class="wrap">
        <div class="header">
            <div class="title">
                <h1>AI vs Real Image Detector</h1>
                <p>Gemini AI Forensics Engine</p>
            </div>
            <button class="btn" id="runAnalysisTop">Run Analysis</button>
        </div>
        <div class="grid">
            <div class="left-col">
                <div class="card">
                    <div id="dropArea" class="drop-area">
                        <input id="fileInput" type="file" accept="image/*" style="display:none">
                        <div style="margin-bottom:10px">Drag & Drop Image</div>
                        <a id="selectBtn" class="select-link">Select File</a>
                    </div>
                    <div id="previewBox" class="preview" style="display:none">
                        <div class="scan-line" id="scanLine"></div>
                        <img id="previewImage" src="" alt="preview">
                    </div>
                    <div class="analyze-bar"><div class="fill" id="progressFill"></div></div>
                    <div id="analysisStatus" style="font-size:12px; color:var(--muted); margin-top:8px">Ready for input...</div>
                    
                    <div style="margin-top:25px;">
                        <div style="font-size:13px; font-weight:700; margin-bottom:10px;">FORENSIC CROPS</div>
                        <div class="proof-grid" id="proofGrid">
                            <div class="proof-slot"><div class="proof-thumb" id="p0"></div></div>
                            <div class="proof-slot"><div class="proof-thumb" id="p1"></div></div>
                            <div class="proof-slot"><div class="proof-thumb" id="p2"></div></div>
                            <div class="proof-slot"><div class="proof-thumb" id="p3"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-col">
                <div class="score-card" style="text-align:center">
                    <div id="verdictTag" class="tag warn">Pending</div>
                    <div class="meter">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="8"></circle>
                            <circle id="meterArc" cx="50" cy="50" r="45" fill="none" stroke="var(--accent2)" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round"></circle>
                        </svg>
                        <div class="num" id="meterNum">0%</div>
                    </div>
                    <div id="mainVerdictText" style="font-size:13px; color:var(--muted)">Upload an image.</div>
                </div>

                <div class="card" style="margin-top:20px">
                    <div style="font-size:13px; font-weight:700; margin-bottom:10px; color:var(--accent2)">FORENSIC ANALYSIS NOTES</div>
                    <div id="aiComments" style="font-size:13px; line-height:1.6; color:var(--muted); min-height:60px; font-style:italic;">
                        After analysis, AI observations about lighting, textures, and artifacts will appear here.
                    </div>
                </div>

                <div class="card" style="margin-top:20px">
                    <div style="font-size:13px; font-weight:700; margin-bottom:10px;">INTEGRITY LOG</div>
                    <table class="breakdown-table">
                        <tr><td>Metadata</td><td id="breakdownExif" style="text-align:right">--</td></tr>
                        <tr><td>Spectral</td><td id="breakdownSpectral" style="text-align:right">--</td></tr>
                        <tr><td>Engine</td><td style="text-align:right; color:var(--success)">Gemini 1.5</td></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // Determine backend hosts to try (in order).
    const FALLBACK_SERVER_IP = '172.16.213.54';
    const pageHost = (window.location && window.location.hostname) ? window.location.hostname : '';
    const candidateHosts = [];
    if (pageHost && pageHost !== 'localhost') candidateHosts.push(pageHost);
    candidateHosts.push('127.0.0.1');
    // add detected fallback / previously observed server IP
    candidateHosts.push(FALLBACK_SERVER_IP);
    // make unique
    const uniqueHosts = [...new Set(candidateHosts)];
    const API_CANDIDATES = uniqueHosts.map(h => `http://${h}:8000`);
    console.log('API candidates:', API_CANDIDATES);
    const fileInput = document.getElementById('fileInput');
    const selectBtn = document.getElementById('selectBtn');
    const previewBox = document.getElementById('previewBox');
    const previewImage = document.getElementById('previewImage');
    const progressFill = document.getElementById('progressFill');
    const analysisStatus = document.getElementById('analysisStatus');
    const meterArc = document.getElementById('meterArc');
    const meterNum = document.getElementById('meterNum');
    const verdictTag = document.getElementById('verdictTag');
    const mainVerdictText = document.getElementById('mainVerdictText');
    const scanLine = document.getElementById('scanLine');
    const aiComments = document.getElementById('aiComments');

    let uploadedFile = null;

    selectBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
        uploadedFile = e.target.files[0];
        if (uploadedFile) {
            previewImage.src = URL.createObjectURL(uploadedFile);
            document.getElementById('dropArea').style.display = 'none';
            previewBox.style.display = 'flex';
            analysisStatus.textContent = "Image Loaded. Click 'Run Analysis'.";
            aiComments.textContent = "Waiting for analysis to generate forensic notes...";
        }
    };

    document.getElementById('runAnalysisTop').onclick = async () => {
        if (!uploadedFile) return alert("Select an image first!");

        // Reset & Start UI Animation
        scanLine.style.display = 'block';
        progressFill.style.width = '40%';
        analysisStatus.textContent = "Contacting Gemini AI Engine on Port 8000...";
        aiComments.textContent = "Analyzing pixel patterns and lighting inconsistencies...";
        
        const formData = new FormData();
        formData.append('image', uploadedFile);

        try {
            // BACKEND PORT 8000 CONNECTION
            async function fetchWithTimeout(url, options = {}, timeout = 60000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const resp = await fetch(url, {...options, signal: controller.signal});
                    clearTimeout(id);
                    return resp;
                } catch (e) {
                    clearTimeout(id);
                    throw e;
                }
            }

            // Try candidate API bases in order until one succeeds
            let response = null;
            const tried = [];
                for (const base of API_CANDIDATES) {
                const requestUrl = `${base}/analyze`;
                tried.push(requestUrl);
                console.log('Attempting', requestUrl);
                    try {
                    // allow longer time for model inference
                    response = await fetchWithTimeout(requestUrl, { method: 'POST', body: formData }, 60000);
                    if (response && response.ok) break;
                } catch (e) {
                    console.warn('Failed', requestUrl, e && e.name ? e.name : e);
                    response = null;
                }
            }

            if (!response) throw new Error("Backend server not responding on any candidate URLs: " + tried.join(', '));

            const data = await response.json();

            // Finish UI
            progressFill.style.width = '100%';
            scanLine.style.display = 'none';
            analysisStatus.textContent = "Analysis Complete.";

            // Update Verdict
            verdictTag.textContent = data.verdict;
            verdictTag.className = `tag ${data.verdict === 'AUTHENTIC' ? 'real' : 'ai'}`;
            mainVerdictText.textContent = data.verdict === 'AI SYNTHETIC' ? "Synthetic artifacts found." : "Natural camera noise detected.";

            // Update AI Comments from Backend
            aiComments.textContent = data.comments || "Analysis finished. No specific anomalies reported by the engine.";
            aiComments.style.color = "#e6eefb";
            aiComments.style.fontStyle = "normal";

            // Update Score Meter (defensive: handle missing/invalid confidence)
            let conf = Number(data && data.confidence);
            if (!isFinite(conf)) conf = 0;
            meterNum.textContent = conf + '%';
            const offset = 283 - (conf/100 * 283);
            meterArc.style.strokeDashoffset = offset;

            // Update Stats Table
            document.getElementById('breakdownExif').textContent = data.metadata;
            document.getElementById('breakdownSpectral').textContent = data.spectral;

            generateCrops();

        } catch (err) {
            console.error(err);
            const msg = err && err.message ? err.message : err;
            alert("Connection Failed! Make sure 'python app.py' is running on Port 8000.\n" + msg);
            scanLine.style.display = 'none';
            progressFill.style.width = '0%';
            aiComments.textContent = "Error: Connection lost or Backend Offline.";
        }
    };

    function generateCrops() {
        for(let i=0; i<4; i++) {
            const slot = document.getElementById('p' + i);
            slot.innerHTML = `<img src="${previewImage.src}" style="filter: contrast(150%) brightness(80%)">`;
        }
    }
</script>
</body>
</html>